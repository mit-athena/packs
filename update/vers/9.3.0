#!/bin/sh

echo "MINIROOT=true"					>> $CONFVARS
echo "NEWOS=true"					>> $CONFVARS
echo "NEWDEVS=true"					>> $CONFVARS
echo "OSCHANGES=true"					>> $CONFVARS

cat $LIBDIR/solaris-9.2-pkgs				>> $OLDPKGS
cat $LIBDIR/solaris-9.2-patches				>> $OLDPTCHS

# This file will be inaccurate after we remove the pkgs and patches.
echo "/var/sadm/install/contents"			>> $DEADFILES

cat $LIBDIR/solaris-9.2-os-symlinks			>> $DEADFILES

# Leftover from 9.1; if we leave it around, it sends the 9.3 update
# into an infinite reboot cycle trying to run a nonexistent syncconf.
echo "/etc/init.d/athena.config"			>> $DEADFILES

# Create the lists of packages and patches to install.
cat $LIBDIR/solaris-9.3-pkgs				> $PACKAGES
cat $LIBDIR/solaris-9.3-patches				> $PATCHES

echo "/etc/minor_perm"					>> $CONFCHG
echo "/etc/driver_aliases"				>> $CONFCHG
echo "/etc/devlink.tab"					>> $CONFCHG

# Nuke the files tracked from the old srvd.
cat $LIBDIR/solaris-9.2-srvd-files			>> $DEADFILES

echo "/etc/.login"					>> $OSCONFCHG
echo "/etc/default/syslogd"				>> $OSCONFCHG
echo "/etc/inet/inetd.conf"				>> $OSCONFCHG
echo "/etc/inet/services"				>> $OSCONFCHG
echo "/etc/profile"					>> $OSCONFCHG
echo "/etc/syslog.conf"					>> $OSCONFCHG
echo "/etc/system"					>> $OSCONFCHG
echo "/var/spool/cron/crontabs/root"			>> $OSCONFCHG

# Inaugurate foo.athena files for each config file foo which did NOT
# change between 9.2.n and 9.3.0.  This will prevent the file from
# being replaced needlessly when the containing package is installed
# on a private machine.
inaugurate() {
  file=$1
  pkg=$2

  grep -s "^$file\$" $CONFCHG > /dev/null || \
    cp -p /srvd/pkg/9.3.0/$pkg/reloc$file $file.athena
}

inaugurate /.cshrc MIT-dotfiles
inaugurate /.login MIT-dotfiles
inaugurate /.profile MIT-dotfiles
inaugurate /.xsession MIT-dotfiles
inaugurate /etc/.login MIT-dotfiles
inaugurate /etc/athena/athinfo.defs MIT-athinfod
inaugurate /etc/athena/attach.conf MIT-locker
inaugurate /etc/athena/newsyslog.conf MIT-ws
inaugurate /etc/default/sulogin MIT-ws
inaugurate /etc/default/syslogd MIT-ws
inaugurate /etc/inet/inetd.conf MIT-ws
inaugurate /etc/inet/services MIT-ws
inaugurate /etc/ftpusers MIT-krb5
inaugurate /etc/ifhp.conf MIT-ifhp
inaugurate /etc/lpd.conf MIT-lprng
inaugurate /etc/lpd.perms MIT-lprng
inaugurate /etc/mail/aliases MIT-sendmail
inaugurate /etc/mail/sendmail.cf MIT-sendmail
inaugurate /etc/named.conf MIT-bind
inaugurate /etc/ntp.conf MIT-ntp
inaugurate /etc/profile MIT-dotfiles
inaugurate /etc/resolv.conf MIT-bind
inaugurate /etc/shells MIT-ws
inaugurate /etc/ssh_config MIT-openssh
inaugurate /etc/sshd_config MIT-openssh
inaugurate /etc/syslog.conf MIT-ws
inaugurate /etc/system MIT-ws

# The .old version of the root crontab will be saved in a different
# directory starting in this release.  Move an existing .old file
# there now to get it out of the way, though it will be overwritten
# there anyway when MIT-ws is installed.
if [ -f /var/spool/cron/crontabs/root.old ]; then
  mkdir -p /var/athena/update.save
  mv /var/spool/cron/crontabs/root.old /var/athena/update.save/crontab.root.old
fi
