#!/bin/sh

# Get standard options from command line or defaults.
. ais-options

#
# Perform miscellaneous customizations, including those needed for proper
# functioning on MIT's network.
#

# Routines for editing config files.

config=/etc/config

configopt()
{
    rm -f "${AIS_ROOT}/$config/$1"
    echo "$2" > "${AIS_ROOT}/$config/$1"
    chmod 644 "${AIS_ROOT}/$config/$1"
}

syncvar()
{
    case "$2" in
    true|on)
	configopt "$1" on
	;;
    false|off)
	configopt "$1" off
	;;
    *)
	configopt "$1" "$2"
	;;
    esac
}

put()
{
    echo "$2" > "${AIS_ROOT}/$1"
}

append()
{
    echo "$2" >> "${AIS_ROOT}/$1"
}


case ${AIS_MODE} in
    root|swap)
	if [ "${AIS_HOST}" = "nobody" ]; then
		echo "Enter hostname: \c"
		read AIS_HOST
	fi

	if [ "${AIS_ADDR}" = "0.0.0.0" ]; then
		echo "Enter IP address: \c"
		read AIS_ADDR
	fi
	;;
    afs)
	# AFS installation remains pure.
	exit 0
	;;
esac

#
# Miscellaneous configuration
#
syncvar timed off
syncvar sendmail off
syncvar webface off
syncvar verbose on

#
# Hostname and routing configuration
#
syncvar autoconfig_ipaddress off
syncvar routed off

case ${AIS_MODE} in
    root|swap)
	# Get first component of host name.  If the host name is not
	# fully qualified, append the domain name.
	first=`echo ${AIS_HOST} | awk -F. '{ print $1 }'`
	if [ "${AIS_HOST}" = "$first" ]; then
		AIS_HOST=${AIS_HOST}.${AIS_DOMAIN}
	fi
	# Use netparams program w/ masks file if available,
	# otherwise fall back to using old defaults.
	if [ -r ${AIS_SRVD}/etc/athena/masks -a \
	     -x ${AIS_SRVD}/etc/athena/netparams ]; then
		set -- `${AIS_SRVD}/etc/athena/netparams  \
		    -f ${AIS_SRVD}/etc/athena/masks "${AIS_ADDR}"`
		netmask=$1
		broadcast=$3
		gateway=$4
	else	
		echo "Using default netmask/broadcast/gateway settings"
		netmask=0xffff0000
		net=`echo ${AIS_ADDR} | awk -F. '{ print $1 "." $2 }'`
		broadcast=$net.255.255
		gateway=$net.0.1
	fi
	put    /etc/sys_id ${AIS_HOST}
	put    $config/ifconfig-1.options \
		"netmask $netmask broadcast $broadcast"
	put    /etc/hosts "#"
	append /etc/hosts "# Internet host table"
	append /etc/hosts "#"
	append /etc/hosts "127.0.0.1	localhost"
	append /etc/hosts "${AIS_ADDR}	${AIS_HOST} ${first}"

	cp ${AIS_LIB}/static-route.options \
	    ${AIS_ROOT}/$config/static-route.options
	append $config/static-route.options \
	    "\$ROUTE \$QUIET add net default $gateway"
	;;

    diskless)
	# This configuration happens at boot time on diskless.
	# The initramdrive script deals with the proper population.
	put /etc/TIMEZONE TZ=EST5EDT
	;;
esac

#
# named configuration
#
# We always want to run a local named, but when doing an Athena install,
# we want the config files to get tracked in, since, for 8.2, we're
# running a later version of BIND, not the vendor version, with a
# different set of config files.
syncvar named on
if [ "${AIS_ATHENAINSTALL}" -eq 0 ]; then
    cp ${AIS_LIB}/named.* ${AIS_ROOT}/etc
    cp ${AIS_LIB}/resolv.conf ${AIS_ROOT}/etc
fi
