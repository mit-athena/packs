#!/sbin/sh
# $Id: athena.config,v 1.2 1999-10-04 18:39:52 rbasch Exp $
#
# Make sure the state of the system is synchronized with /etc/athena/rc.conf.
#

IS_ON=/sbin/chkconfig

if $IS_ON verbose ; then
	OPTS=
else            # For a quiet startup and shutdown
	OPTS=-q
fi

case "$1" in
start|stop)
	# Try to deal with a trashed group file.  If there is no
	# sys group, try copying in group.local.
	grep -q '^sys:' /etc/group || {
		[ -s /etc/group.local ] &&
		echo "Restoring group from group.local..." &&
		cp -p /etc/group.local /etc/group
	}

	# Try to deal with a trashed passwd file.  If there is no
	# root account, try copying in passwd.local, and reboot for
	# a clean start-up.
	grep -q '^root:' /etc/passwd || {
		[ -s /etc/passwd.local ] &&
		cp -p /etc/passwd.local /etc/passwd &&
		[ start = "$1" ] &&
		echo "Restored passwd from passwd.local, rebooting..." &&
		sleep 5 &&
		sync &&
		# The following command reboots immediately.  Note that
		# "killall rc2" will not work when passwd is trashed,
		# because the mount of /proc will have failed.
		/usr/sbin/uadmin 1 1
	}

	if [ -f /dev/MAKEDEV.new ]; then
		rm -f /dev/MAKEDEV.new
		echo "Running MAKEDEV..."
		(cd /dev; ./MAKEDEV > /dev/null)
	fi

	. /etc/athena/rc.conf

	status=0
	case "$PUBLIC" in
	true)
		/etc/athena/syncconf $OPTS -a
		status=$?
		;;
	false)
		case "$SYNCCONFIG" in
		true)
			/etc/athena/syncconf $OPTS
			status=$?
			;;
		esac
	esac

	# syncconf exits with status 1 if rc2 is modified.  Reboot if this
	# happened and we're running syncconf on startup.
	if [ "$1" = start -a "$status" -eq 1 ]; then
		reboot
		killall rc2
	fi
        ;;

*)
        echo "usage: athena.config {start|stop}"
        ;;
esac

