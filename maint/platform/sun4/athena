# /etc/init.d/athena - Start/Stop the athena daemons
#
#

# First, set up some useful variables.

HOME=/; export HOME
PATH=/bin:/usr/ucb:/usr/sbin:/etc:/sbin; export PATH

umask 022


case $1 in 
'start')

echo  "MIT configuration..." > /dev/console

# Read configuration variables

. /etc/athena/rc.conf

# Clean up the password file.

echo "Cleaning up passwd file: \c"				>/dev/console
if [ -f /etc/passwd.local -a -f /etc/shadow.local ]; then
	echo "recovered from passwd.local... \c"		>/dev/console
	/bin/cp /etc/passwd.local /etc/passwd
	/bin/cp /etc/shadow.local /etc/shadow
fi
echo "done."							>/dev/console

# Clean up the group file.

if [ -f /etc/group.local ]; then
	echo "Recovering group file... \c"			>/dev/console
	/bin/cp /etc/group.local /etc/group
	echo "done."						>/dev/console
fi

# Remove old cruft and locks
rm -rf /.deleted /etc/sm/* /etc/sm.bak/*

# Reset time with the time hub
if [ "${TIMECLIENT}" = "true" ]; then
	echo ""							>/dev/console
	echo  "Setting time: \c"				>/dev/console
	if [ -f /etc/athena/gettime ]; then
        	/etc/athena/gettime -s ${TIMEHUB}		>/dev/console
	else
		echo "Can't set time! gettime not found!"	>/dev/console
	fi
fi

if [ "${AFSSRV}" = "true" ]; then
	echo ""							>/dev/console
	echo "AFS server: \c"					>/dev/console
	if [ -f /usr/afs/bin/bosserver ]; then
		/usr/afs/bin/bosserver &
		echo "started."					>/dev/console
	else
		echo "Can't start AFS server!"
	fi
fi

# Start up afsd in foreground, in case any daemons are coming off AFS
if [ "${AFSCLIENT}" != "false" ]; then
	echo ""							>/dev/console
	echo  "Starting AFS client: \c"				>/dev/console

	if [ \( "${AFSADJUST}" = "true" -o "${PUBLIC}" = "true" \) \
	     -a -d /usr/vice/cache/ ]; then

		echo "Adjusting the cache size..."		>/dev/console
		rm -f /usr/vice/etc/cacheinfo.old
		mv -f /usr/vice/etc/cacheinfo /usr/vice/etc/cacheinfo.old
		/bin/df -bk /usr/vice/cache/ | \
		  /bin/awk ' \
			(NR == 2) { x = int($2*3/4); \
			printf("/afs:/usr/vice/cache:%d\n",x);};' \
		  > /usr/vice/etc/cacheinfo

		sed -n -e '1s/^.*:\([^:]*\)$/New AFS cache size = \1K/p' \
			/usr/vice/etc/cacheinfo 		>/dev/console
	fi

	modload /kernel/fs/afs

	if [ "${TIMESRV}" = "true" -o "${TIMECLIENT}" != "true" ]; then
		AFSOPTS="-nosettime"
	fi
	if [ "${AFSCLIENT-true}" = "true" ]; then
		AFSCLIENT=4
	fi
	AFSOPTS="${AFSOPTS} -daemons ${AFSCLIENT}"
	/etc/afsd ${AFSOPTS}
	if [ -f  /afs/athena/service/aklog ]; then
          cp -p /afs/athena.mit.edu/service/aklog /bin/athena/aklog
	fi
	sh /etc/athena/config_afs
fi

echo "Loading pcfile system... \c"				>/dev/console
/usr/sbin/modload /usr/kernel/fs/pcfs
echo "Loading fd driver... \c"					>/dev/console
/usr/sbin/modload /usr/kernel/fs/fdfs
echo "Done"

# fsid not working yet so next block commented out; still true???
#if [ "${NFSCLIENT}" != "false" ]; then
#	echo  "NFS client: \c"					>/dev/console
#	echo  "flushing old NFS connections... \c"		>/dev/console
#	/bin/athena/fsid -p -a
#	echo "done."						>/dev/console
#fi

echo "Removing old attach mount points... \c"			>/dev/console
/bin/athena/detach -O -n -h -a
echo "done."							>/dev/console

echo ""								>/dev/console

if [ "${PUBLIC}" = "true" ]; then
	/bin/cp /dev/null /usr/tmp/attachtab
fi

if [ "${RVDCLIENT}" = "true" ]; then
	echo "Getting cluster information: \c"			>/dev/console
	/etc/athena/save_cluster_info
	if [ -f /etc/athena/clusterinfo.bsh ]; then
		. /etc/athena/clusterinfo.bsh
		echo "Attaching system libraries:"		>/dev/console
		/bin/athena/attach -h -n -o hard $SYSLIB	>/dev/console
		echo "done."					>/dev/console
	else
		echo "no information available..."		>/dev/console
	fi
fi

# Take a new release, if necessary.
if [ "${AUTOUPDATE}" = "true" -a -f /srvd/auto_update ]; then
	echo  "Checking /srvd/auto_update... \c"		>/dev/console
	/srvd/auto_update rc < /dev/console > /dev/console 2>&1
	echo "done."						>/dev/console
elif [ -f /srvd/.rvdinfo ]; then
	NEWVERS=`awk '{a=$5}; END{print a}' /srvd/.rvdinfo`
	VERSION=`awk '{a=$5}; END{print a}' /etc/athena/version`
	if [ "${NEWVERS}" != "${VERSION}" ]; then
		cat <<EOF					>/dev/console
The workstation software version ($VERSION) does not match the
version on the system packs ($NEWVERS).  A new version of software
may be available.  Please contact Athena Operations (x3-1410) to
have your workstation updated.
EOF
	 if [ ! -f /usr/tmp/update.check -a -f /usr/ucb/logger ]; then
       	    /usr/ucb/logger -t `uname -n` -p user.notice at revision $VERSION
	    cp /dev/null /usr/tmp/update.check
	 fi
	fi
fi

echo ""								>/dev/console

# The audio driver on the Sparcstation 5 has a habit of disappearing.
# So we put it back periodically...
#if [ -f /kernel/drv/audiocs ]; then
#	case `/bin/athena/machtype -c` in
#	  SPARC/5)
#	      /bin/echo "Adding audio dev for Sparc 5... \c"	>/dev/console
#	      /usr/sbin/add_drv  -m '* 0755 root sys' -i 'SUNW,CS4231' /kernel/drv/audiocs > /dev/null 2>&1
#	      /usr/sbin/audlinks
#	      echo "done."					>/dev/console
#	      ;;
#	  *)
#	      ;;
#	esac
#fi

# If this is a PUBLIC workstation, ensure that that there are no hacks.
# Do not update rc.conf if the workstation and srvd are different versions.
if [ "${PUBLIC}" = "true" ]; then
	echo "Public workstation cleanup... \c"			>/dev/console
	rm -rf /.hushlogin /etc/X0.hosts /usr/local/
	rm -f /etc/*.local /etc/athena/*.local /etc/athena/login/*.local
	rm -f /var/spool/cron/crontabs/root
	cp -p /srvd/etc/crontab.root.add /var/spool/cron/crontabs/root
	cp -p /srvd/etc/athena/attach.conf /etc/athena/attach.conf
	cp -p /srvd/etc/inet/inetd.conf /etc/inet/inetd.conf
	cp -p /srvd/etc/athena/inetd.conf /etc/athena/inetd.conf
	cp -p /srvd/etc/minor_perm /etc/minor_perm
	if [ -r /srvd/etc/passwd ]; then
	  cp -p /srvd/etc/passwd /etc/passwd.local
	  chmod 644 /etc/passwd.local
	  chown root /etc/passwd.local
	fi
	if [ -r /srvd/etc/shadow ]; then
	  cp -p /srvd/etc/shadow /etc/shadow.local
	  chmod 600 /etc/shadow.local
	  chown root /etc/shadow.local
	fi
	cp -p /etc/passwd.local /etc/passwd
	cp -p /etc/shadow.local /etc/shadow
	chmod 600 /etc/shadow
	chmod 666 /dev/audio /dev/audioctl
	cp -p /srvd/etc/group /etc/group.local
	cp -p /etc/group.local /etc/group
	cp -p /srvd/etc/syslog.conf /etc/syslog.conf

	cp /dev/null /etc/named.local
	cp -p /srvd/etc/netspy /etc/netspy
	cp /dev/null /etc/X0.hosts
	cp -p /etc/inet/hosts /etc/inet/hosts.save
	if [ -f /srvd/.rvdinfo ]; then
            NEWVERS=`awk '{a=$5} END{print a}' /srvd/.rvdinfo`
	    THISVERS=`awk '{a=$5} END{print a}' /etc/athena/version`
	    if [ "${NEWVERS}" = "${THISVERS}" ]; then
		echo "Running track..."				>/dev/console
		/usr/athena/etc/track -F /os -T / -W /srvd/usr/athena/lib \
			-s stats/os_rvd slists/os_rvd
		/usr/athena/etc/track
		cp -p /etc/inet/hosts.save /etc/inet/hosts
		rm -f /etc/inet/hosts.save
		if [ -f /srvd/etc/athena/rc.conf ]; then
       			sed -n  -e "s/^HOST=[^;]*/HOST=${HOST}/" \
			  -e "s/^ADDR=[^;]*/ADDR=${ADDR}/" \
			  -e "s/^MACHINE=[^;]*/MACHINE=${MACHINE}/" \
			  -e p /srvd/etc/athena/rc.conf > /etc/athena/rc.conf
       	        	. /etc/athena/rc.conf
		fi
	    fi
	fi
        echo "done."						>/dev/console
fi

# Dealing with sendmail.cf
if [ "${NEWMAILCF}" = "true" ];then
	echo "Copying sendmail.cf... \c"			>/dev/console
	cp -p /srvd/etc/mail/sendmail.cf /etc/mail/sendmail.cf
	cp -p /os/etc/mail/aliases /etc/mail/aliases
fi
# no matter what freeze the configuration
/usr/lib/sendmail -bz 
echo "done."							>/dev/console

echo "Removing sendmail temporary files."			>/dev/console
if [ -d /var/spool/mqueue ]; then
  (cd /var/spool/mqueue; rm -f nf* lf*)
fi

# Start standard daemons
echo ""								>/dev/console
echo  "Starting Athena daemons: \c"				>/dev/console

#	if [ "${TIMECLIENT}" = "true" ]; then
#		echo  "timed..."				>/dev/console
#		/etc/athena/timed &
#	fi

# Start Athena's inetd
echo "inetd... \c"						>/dev/console
/etc/athena/inetd &

if [ "${SNMP}" = "true" ]; then
	echo  "snmpd... \c"					>/dev/console
	/etc/athena/snmpd &
fi

if [ "${SENDMAIL}" = "true" ]; then
	echo  "sendmail... \c"					>/dev/console
	/usr/lib/sendmail -bd -q1h;
fi

if [ "${ZCLIENT}" = "true" ]; then
	echo  "zhm... \c"					>/dev/console
	rm -f /etc/athena/zhm.pid
	/etc/athena/zhm &
fi

if [ "${MRUPDATE}" = "true" ]; then
	echo  "update_server... \c"				>/dev/console
	/usr/athena/etc/update_server &
fi

echo "done."							>/dev/console
echo ""								>/dev/console

if [ "${PUBLIC}" = "true" ]; then
	echo  "Clearing out /mit... \c"				>/dev/console
	/bin/rm -f /mit/*
	/bin/rmdir /mit/*  >/dev/null
	echo "done."						>/dev/console
fi

echo "Editing /etc/motd... \c"					>/dev/console
awk '{ prev = $0 }; END { print prev }' /etc/athena/version	> /tmp/t1
if [ "${PUBLIC}" != "true" ]; then
	awk '{ if ( NR > 1 ) print $0 }' /etc/motd		>>/tmp/t1
fi
mv /tmp/t1 /etc/motd
chmod 644 /etc/motd
echo "done."							>/dev/console

echo  "Fixing noattach, nocreate, noremote, and nologin... \c"	>/dev/console
if [ "${NOCREATE}" = "true" ]; then
	echo "" >> /etc/nocreate
else
	rm -f /etc/nocreate
fi

if [ "${NOATTACH}" = "true" ]; then
	echo  "" >> /etc/noattach
else
	rm -f /etc/noattach
fi

if [ "${NOREMOTE}" = "true" ]; then
        echo  "" >> /etc/noremote
else
        rm -f /etc/noremote
fi

echo "done."							>/dev/console

rm -f /etc/nologin
echo "Logins now possible."					>/dev/console

echo " done!"							>/dev/console
	;;
'stop')
	pid=`/usr/bin/ps -e | /usr/bin/grep timed | /usr/bin/sed -e 's/^  *//' -e 's/ .*//'`
	if test "$pid"
	then
		kill $pid
	fi
	pid=`/usr/bin/ps -e | /usr/bin/grep snmpd | /usr/bin/sed -e 's/^  *//' -e 's/ .*//'`
	if test "$pid"
	then
		kill $pid
	fi
	pid=`/usr/bin/ps -e | /usr/bin/grep zhm | /usr/bin/sed -e 's/^  *//' -e 's/ .*//'`
	if test "$pid"
	then
		kill $pid
	fi
	;;
*)
	echo "usage: /etc/rc2.d/S90athena {start|stop}"
	;;
esac








