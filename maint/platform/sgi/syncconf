#!/bin/sh

debug=1

CONFIG=/etc/config
SETCONFIG="/sbin/chkconfig -f"
RCCONF="/etc/athena/rc.conf"
RCTIME="/etc/athena/.rc.conf.sync"

configbool()
{
  if [ $debug = 1 ]; then
    echo $SETCONFIG "$1" "$2"
  else
    $SETCONFIG "$1" "$2"
  fi
}

configopt()
{
  if [ $debug = 1 ]; then
    echo "echo $2 > $CONFIG/$1"
  else
    echo "$2" > "$CONFIG/$1"
  fi
}

syncvar()
{
    case "$2" {
  true|on)
      configbool "$1" on
      ;;
  false|off)
      configbool "$1" off
      ;;
  *)
      configopt "$1" "$2"
      ;;
    }
}

remove()
{
  if [ $debug = 1 ]; then
    echo rm -f "$1"
  else
    rm -f "$1"
  fi
}

move()
{
  if [ $debug = 1 ]; then
    echo mv "$1" "$2"
  else
    mv "$1" "$2"
  fi
}

put()
{
  if [ $debug = 1 ]; then
    echo echo "$2 > $1"
  else
    echo "$2" > "$1"
  fi
}

append()
{
  if [ $debug = 1 ]; then
    echo echo "$2 >> $1"
  else
    echo "$2" >> "$1"
  fi
}

usage()
{
  echo "Usage: syncconf\c"
  for k in $USAGE; do
    echo " [$k]\c"
  done
  echo ""
}

if [ $debug = 1 ]; then
  RCCONF=/tmp/rc.conf
  RCTIME=/tmp/rc.conf.sync
fi

# ALL="TIMECLIENT TIMESRV AFSCLIENT NFSSRV SENDMAIL SNMP SAVECORE ACCOUNT QUOTAS HOST"
ALL="timeclient timesrv afsclient nfssrv sendmail snmp savecore account quotas host"
USAGE="timeclient|timehub timesrv afsclient nfssrv|nfsclient sendmail snmp savecore account quotas host|addr"

if test -f $RCTIME; then
  update=`find $RCTIME -newer $RCCONF -print`
fi

if test $update; then
  exit
fi

. $RCCONF

j="$*"

if test "$j" = ""; then
  j=$ALL
fi

for i in $j; do
  case "$i" in
  TIMECLIENT|timeclient|TIMEHUB|timehub)
    syncvar timeclient ${TIMECLIENT}
    syncvar timeclient.options ${TIMEHUB}
    ;;
  TIMESRV|timesrv)
    # gettime and AFS time synchronization
    syncvar timed $TIMESRV
    ;;

  AFSCLIENT|afsclient)
    if [ "${AFSCLIENT}" != "false" ]; then

      syncvar afsml true
      syncvar afsclient true

      if [ "${AFSCLIENT}" = "true" ]; then
        AFSCLIENT=4
      fi

      if [ "${TIMECLIENT}" = "false" ]; then
        AFSTIME = "-nosettime"
      fi

      syncvar afsd.options "$AFSTIME -stat 2000 -dcache 800 -daemons $AFSCLIENT -volumes 70"
    else
      syncvar afsml false
      syncvar afsclient false
    fi
    ;;

  NFSSRV|nfssrv|NFSCLIENT|nfsclient)
    if [ "${NFSSRV}" != "false" -o "${NFSCLIENT}" != "false" ]; then
      syncvar nfs true

      case "${NFSCLIENT}" {
        true|false)  remove $CONFIG/biod.options ;;
                 *)  syncvar biod.options "${NFSCLIENT}" ;;
      }

      case "${NFSSRV}" {
              true)  remove $CONFIG/nfsd.options ;;
             false)  syncvar nfsd.options 0 ;;
                 *)  syncvar nfsd.options "${NFSSRV}" ;;
      }
    else
      syncvar nfs false
    fi
    ;;

  SENDMAIL|sendmail)
    if [ "${SENDMAIL}" = "false" ]; then
      move /etc/rc2.d/S50mail /etc/rc2.d/s50mail
    else
      move /etc/rc2.d/s50mail /etc/rc2.d/S50mail
    fi
    ;;

  SNMP|snmp)
    syncvar snmpd $SNMP
    ;;

  SAVECORE|savecore)
    case "${SAVECORE}" {
       true)  minfree=30000000 ;;
      false)  minfree=2000000000 ;;
          *)  minfree=${SAVECORE} ;;
    }
    put /var/adm/crash/minfree $minfree
    ;;

  ACCOUNT|account)
    syncvar acct ${ACCOUNT}
    ;;

  QUOTAS|quotas)
    syncvar quotacheck ${QUOTAS}
    syncvar quotas ${QUOTAS}
    ;;

  HOST|host|ADDR|addr)
    move /etc/sys_id /etc/sys_id.saved
    move /etc/hosts /etc/hosts.saved
    move $CONFIG/staticroute.options $CONFIG/staticroute.options.saved
    move $CONFIG/ifconfig-1.options $CONFIG/ifconfig-1.options.saved

    NET=`echo $ADDR | awk -F. '{ print $1 "." $2 }'`
    GATEWAY=$NET.0.1
    BROADCAST=$NET.255.255

    put    /etc/sys_id $HOST
    put    $CONFIG/staticroute.options $GATEWAY
    put    $CONFIG/ifconfig-1.options "netmask 0xffff0000"
    append $CONFIG/ifconfig-1.options "broadcast $BROADCAST"
    put    /etc/hosts "#"
    append /etc/hosts "# Internet host table"
    append /etc/hosts "#"
    append /etc/hosts "127.0.0.1  localhost"
    append /etc/hosts "$ADDR  $HOST.MIT.EDU $HOST"
    ;;

  *)
    usage
    exit
  esac

touch $RCTIME

done
