Name: athena-openssh
Summary: The Secure remote Shell program
License: BSD
Group: Applications/Internet
Provides: openssh = 3.0.2p1

Requires: athena-krb5 athena-inetd athena-openssl

%description
The openssh secure shell system, as configured for Athena. 

%install
rm -rf $RPM_BUILD_ROOT
mkdir $RPM_BUILD_ROOT
./do.sh -p -s /xxx -d $RPM_BUILD_ROOT install

# Extra file
cp ssh_config $RPM_BUILD_ROOT/etc/ssh_config
cp sshd_config $RPM_BUILD_ROOT/etc/sshd_config

%ifos linux
mkdir -p $RPM_BUILD_ROOT/etc/rc.d/init.d
cp athena-opensshd.rc $RPM_BUILD_ROOT/etc/rc.d/init.d/athena-opensshd
chmod +x $RPM_BUILD_ROOT/etc/rc.d/init.d/athena-opensshd
%else
mkdir -p $RPM_BUILD_ROOT/etc/init.d
mkdir -p $RPM_BUILD_ROOT/etc/rc2.d
mkdir -p $RPM_BUILD_ROOT/etc/rc0.d
cp athena-opensshd.rc $RPM_BUILD_ROOT/etc/init.d/athena-opensshd
chmod +x $RPM_BUILD_ROOT/etc/init.d/athena-opensshd
ln -s ../init.d/athena-opensshd $RPM_BUILD_ROOT/etc/rc2.d/S91athena-opensshd
ln -s ../init.d/athena-opensshd $RPM_BUILD_ROOT/etc/rc0.d/K91athena-opensshd
%endif

find $RPM_BUILD_ROOT -type f -or -type l |
  sed -e "s|^$RPM_BUILD_ROOT||" \
      -e "s|^/etc/ssh_config$|%config \0|" \
      -e "s|^/etc/sshd_config$|%config \0|" |
  sort > rpm.filelist

%post
grep -q ^SSHD /etc/athena/rc.conf || cat << EOF >> /etc/athena/rc.conf
SSHD=false;		export SSHD		#  Secure shell daemon
EOF

if [ ! -f /etc/ssh_host_key ]; then
	echo "Generating ssh v1 RSA host key."
	/usr/athena/bin/ssh-keygen -b 1024 -t rsa1 -f /etc/ssh_host_key -N ''
fi

if [ ! -f /etc/ssh_host_rsa_key ]; then
        echo "Generating ssh v2 RSA host key."
	/usr/athena/bin/ssh-keygen -b 1024 -t rsa -f /etc/ssh_host_rsa_key \
	    -N ''
fi

if [ ! -f /etc/ssh_host_dsa_key ]; then
	echo "Generating ssh v2 DSA host key."
	/usr/athena/bin/ssh-keygen -b 1024 -t dsa -f /etc/ssh_host_dsa_key \
	    -N ''
fi

%ifos linux
chkconfig --add athena-opensshd
%endif

%ifos linux
%preun
if [ $1 = 0 ]; then
  chkconfig --del athena-opensshd
fi
%endif
