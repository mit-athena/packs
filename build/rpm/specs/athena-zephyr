Name: athena-zephyr
Summary: The Athena Zephyr instant messaging system
License: MIT
Group: System Environment/Libraries

Requires: athena-krb5 athena-ares athena-hesiod athena-libss athena-libet

%description
Zephyr provides an instant messaging system for users in the Athena
networked environment.

%install
rm -rf $RPM_BUILD_ROOT
mkdir $RPM_BUILD_ROOT
./do.sh -p -s /xxx -d $RPM_BUILD_ROOT install

# Extra files; see prep/athena-zephyr
cp zephyr.vars $RPM_BUILD_ROOT/etc/athena/zephyr.vars

%ifos linux
mkdir -p $RPM_BUILD_ROOT/etc/rc.d/init.d
cp zhm.rc $RPM_BUILD_ROOT/etc/rc.d/init.d/zhm
cp zephyrd.rc $RPM_BUILD_ROOT/etc/rc.d/init.d/zephyrd
chmod +x $RPM_BUILD_ROOT/etc/rc.d/init.d/zhm 
chmod +x $RPM_BUILD_ROOT/etc/rc.d/init.d/zephyrd
%else
mkdir -p $RPM_BUILD_ROOT/etc/init.d
mkdir -p $RPM_BUILD_ROOT/etc/rc2.d
mkdir -p $RPM_BUILD_ROOT/etc/rc0.d
cp zhm.rc $RPM_BUILD_ROOT/etc/init.d/zhm
cp zephyrd.rc $RPM_BUILD_ROOT/etc/init.d/zephyrd
chmod +x $RPM_BUILD_ROOT/etc/init.d/zhm
chmod +x $RPM_BUILD_ROOT/etc/init.d/zephyrd
ln -s ../init.d/zhm $RPM_BUILD_ROOT/etc/rc2.d/S91zhm
ln -s ../init.d/zhm $RPM_BUILD_ROOT/etc/rc0.d/K91zhm
ln -s ../init.d/zephyrd $RPM_BUILD_ROOT/etc/rc2.d/S91zephyrd
ln -s ../init.d/zephyrd $RPM_BUILD_ROOT/etc/rc0.d/K91zephyrd
%endif

%ifos linux
mkdir -p $RPM_BUILD_ROOT/etc/athena/network-scripts/system
cp system-zephyr.sh $RPM_BUILD_ROOT/etc/athena/network-scripts/system/50zephyr
chmod +x $RPM_BUILD_ROOT/etc/athena/network-scripts/system/50zephyr

mkdir -p $RPM_BUILD_ROOT/etc/athena/network-scripts/user
cp user-zephyr.sh $RPM_BUILD_ROOT/etc/athena/network-scripts/user/50zephyr
chmod +x $RPM_BUILD_ROOT/etc/athena/network-scripts/user/50zephyr
%endif

find $RPM_BUILD_ROOT -type f -or -type l |
  sed -e "s|^$RPM_BUILD_ROOT||" \
      -e "s|^/etc/athena/zephyr.vars$|%config \0|" |
  sort > rpm.filelist

%post
grep -q ^ZCLIENT /etc/athena/rc.conf || cat << EOF >> /etc/athena/rc.conf
ZCLIENT=true;		export ZCLIENT		#  Zephyr client
EOF

grep -q ^ZSERVER /etc/athena/rc.conf || cat << EOF >> /etc/athena/rc.conf
ZSERVER=false;		export ZSERVER		#  Zephyr server
EOF

%ifos linux
chkconfig --add zhm
chkconfig --add zephyrd
%endif

%ifos linux
%preun
if [ $1 = 0 ]; then
  chkconfig --del zhm
  chkconfig --del zephyrd
fi
%endif
