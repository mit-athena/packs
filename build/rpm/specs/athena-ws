Name: athena-ws
Summary: Athena workstation management infrastructure
Copyright: MIT
Group: System Environment/Base
Requires: athena-desync, athena-base, athena-sendmail, athena-gettime, athena-xntp

%description
Various maintenanance and configuration files required for any
Athena workstation.

%install
if [ X$RPM_BUILD_ROOT = X ]; then
  cat 1>&2 << MESSAGE
You must specify a build root in order to build this package.
Use the --buildroot option to RPM or the buildroot rpmrc entry.
MESSAGE
  exit 1
fi

rm -rf $RPM_BUILD_ROOT
mkdir $RPM_BUILD_ROOT
./do.sh -p -s /xxx -d $RPM_BUILD_ROOT install

#Extra stuff
mkdir -p $RPM_BUILD_ROOT/{/usr/athena/man,/etc/athena,/etc/cron.d}
cp masks $RPM_BUILD_ROOT/etc/athena/masks
cp passwd.fallback $RPM_BUILD_ROOT/etc/passwd.fallback
cp syslog.conf $RPM_BUILD_ROOT/etc/syslog.conf.athena
cp update_ws.sh $RPM_BUILD_ROOT/etc/athena/update_ws
cp athena.cron $RPM_BUILD_ROOT/etc/cron.d/athena
chmod +x $RPM_BUILD_ROOT/etc/athena/update_ws

# This file actually goes in the athena-afs package.
rm $RPM_BUILD_ROOT/etc/athena/config_afs

%post
cp XTerm /usr/X11R6/lib/X11/app-defaults/XTerm

cp /etc/syslog.conf.athena /etc/syslog.conf
chkconfig --add athena-ws

# Add warnings on disabled consoles pointing people at tty7.
for i in 1 2 3 4 5 6; do
  if grep -q ^$i: /etc/inittab; then true; else
    echo "$i:2345:once:echo \"Type CTRL-ALT-F7 to log in.\" > /dev/tty$i" >> /etc/inittab
  fi
done

# Turn on the sound card for the cluster workstations.  Unfortunately,
# there is no generic tool, but if we know what kind of card to do, then
# we can do it.
if pnpdump | grep -q CS4236B ; then
  if grep -q cs4232 /etc/conf.modules ; then true ; else
	cat >> /etc/conf.modules << EOF
alias sound cs4232
pre-install sound insmod sound dmabuf=1
alias midi opl3
options opl3 io=0x388
options cs4232 io=0x534 irq=5 dma=1 dma2=0 mpuio=0x330 mpuirq=5
EOF
  fi
fi

# Make sure the permissions on the sound devices are appropriate
chmod 666 /dev/{audio,dsp,midi00,mixer,sequencer,sndstat}

%files
/etc/athena/clean_tmp_areas
/etc/athena/masks
/etc/athena/netparams
/etc/athena/reactivate
/etc/athena/save_cluster_info
/etc/athena/shutdown_notify
/etc/athena/update_ws
/etc/passwd.fallback
/etc/rc.d
/etc/cron.d
%config /etc/syslog.conf.athena
/usr
%config /etc/athena/rc.conf
