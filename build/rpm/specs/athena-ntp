Name: athena-ntp
Summary: The Network Time Protocol, to keep Athena workstations in sync
Copyright: David L. Mills
Group: System Environment/Base
Provides: ntp = 4.1.1

%description
The Network Time Protocol, to keep Athena workstations in sync

%install
rm -rf $RPM_BUILD_ROOT
mkdir $RPM_BUILD_ROOT
./do.sh -p -s /xxx -d $RPM_BUILD_ROOT install

# Extra files
cp ntp.conf $RPM_BUILD_ROOT/etc/ntp.conf

%ifos linux
mkdir -p $RPM_BUILD_ROOT/etc/athena/network-scripts/system
cp system-time.sh $RPM_BUILD_ROOT/etc/athena/network-scripts/system/25time
chmod +x $RPM_BUILD_ROOT/etc/athena/network-scripts/system/25time
%endif

%ifos linux
mkdir -p $RPM_BUILD_ROOT/etc/rc.d/init.d
cp athena-ntp.rc $RPM_BUILD_ROOT/etc/rc.d/init.d/athena-ntp
chmod +x $RPM_BUILD_ROOT/etc/rc.d/init.d/athena-ntp
%else
mkdir -p $RPM_BUILD_ROOT/etc/init.d
mkdir -p $RPM_BUILD_ROOT/etc/rc2.d
mkdir -p $RPM_BUILD_ROOT/etc/rc0.d
cp athena-ntp.rc $RPM_BUILD_ROOT/etc/init.d/athena-ntp
chmod +x $RPM_BUILD_ROOT/etc/init.d/athena-ntp
ln -s ../init.d/athena-ntp $RPM_BUILD_ROOT/etc/rc2.d/S91athena-ntp
ln -s ../init.d/athena-ntp $RPM_BUILD_ROOT/etc/rc0.d/K91athena-ntp
%endif

# It will need this to run.
mkdir -p $RPM_BUILD_ROOT/var/athena

find $RPM_BUILD_ROOT -type f -or -type l |
  sed -e "s|^$RPM_BUILD_ROOT||" \
      -e "s|^/etc/ntp.conf$|%config \0|" |
  sort > rpm.filelist
echo "%dir /var/athena" >> rpm.filelist

%post
grep -q ^TIMESRV /etc/athena/rc.conf || cat << EOF >> /etc/athena/rc.conf
TIMESRV=false;		export TIMESRV		#  Time server?
EOF

grep -q ^TIMECLIENT /etc/athena/rc.conf || cat << EOF >> /etc/athena/rc.conf
TIMECLIENT=true;	export TIMECLIENT	#  Timed client?
EOF

grep -q ^TIMEHUB /etc/athena/rc.conf || cat << EOF >> /etc/athena/rc.conf
TIMEHUB=time.MIT.EDU;	export TIMEHUB		#  Authoritative time source
EOF

%ifos linux
chkconfig --add athena-ntp
%endif

%ifos linux
%preun
if [ $1 = 0 ]; then
  chkconfig --del athena-ntp
fi
%endif
