Name: athena-sendmail
Summary: The Sendmail Mail Transport Agent, for Athena
License: BSD
Group: System Environment/Daemons

Requires: athena-hesiod

%description
The Mail Transfer Agent for Athena.

%install
rm -rf $RPM_BUILD_ROOT
mkdir $RPM_BUILD_ROOT
./do.sh -p -s /xxx -d $RPM_BUILD_ROOT install
rm -f $RPM_BUILD_ROOT/etc/sendmail.st

# Extra files
mkdir -p $RPM_BUILD_ROOT/etc/athena
mkdir -p $RPM_BUILD_ROOT/etc/mail
mkdir -p $RPM_BUILD_ROOT/usr/lib
cp aliases $RPM_BUILD_ROOT/etc/aliases.athena
cp authinfo $RPM_BUILD_ROOT/etc/mail/authinfo
cp sendmail.cf $RPM_BUILD_ROOT/etc/mail/sendmail.cf
cp sendmail-relay-select $RPM_BUILD_ROOT/etc/athena/sendmail-relay-select
cp sendmail.sh $RPM_BUILD_ROOT/usr/sbin/sendmail
chmod +x $RPM_BUILD_ROOT/usr/sbin/sendmail
mkdir -p $RPM_BUILD_ROOT/var/spool/mqueue
%ifos linux
ln -s ../sbin/sendmail $RPM_BUILD_ROOT/usr/lib/sendmail
%endif

%ifos linux
mkdir -p $RPM_BUILD_ROOT/etc/rc.d/init.d
cp athena-sendmail.rc $RPM_BUILD_ROOT/etc/rc.d/init.d/athena-sendmail
chmod +x $RPM_BUILD_ROOT/etc/rc.d/init.d/athena-sendmail
%else
mkdir -p $RPM_BUILD_ROOT/etc/init.d
mkdir -p $RPM_BUILD_ROOT/etc/rc2.d
mkdir -p $RPM_BUILD_ROOT/etc/rc0.d
cp athena-sendmail.rc $RPM_BUILD_ROOT/etc/init.d/athena-sendmail
chmod +x $RPM_BUILD_ROOT/etc/init.d/athena-sendmail
ln -s ../init.d/athena-sendmail $RPM_BUILD_ROOT/etc/rc2.d/S91athena-sendmail
ln -s ../init.d/athena-sendmail $RPM_BUILD_ROOT/etc/rc0.d/K91athena-sendmail
%endif

%ifos linux
mkdir -p $RPM_BUILD_ROOT/etc/athena/network-scripts/system
cp system-sendmail.sh $RPM_BUILD_ROOT/etc/athena/network-scripts/system/75sendmail
chmod +x $RPM_BUILD_ROOT/etc/athena/network-scripts/system/75sendmail
%endif

find $RPM_BUILD_ROOT -type f -or -type l |
  sed -e "s|^$RPM_BUILD_ROOT||" \
      -e "s|^/etc/sendmail.cf$|%config \0|" |
  sort > rpm.filelist
echo "%dir /var/spool/mqueue" >> rpm.filelist


%triggerin -- setup
# /etc/aliases belongs to the setup RPM (as a %config(noreplace) file)
# in RHEL 4.  Replace it with the Athena aliases file if it looks like
# the Red Hat stock version.

# If we ever revise the Athena aliases file and want to replace
# customized aliases files with our new one (as was the old policy for
# that file), we should introduce a versioned comment into the Athena
# aliases file and replace this check with a check that the versioned
# comment in /etc/aliases matches the one in /etc/aliases.athena.

if ! grep -q '^#.*Athena' /etc/aliases; then
  cp /etc/aliases /etc/aliases.old
  cp /etc/aliases.athena /etc/aliases
fi

/usr/sbin/sendmail -bi
exit 0

%post
grep -q ^SENDMAIL /etc/athena/rc.conf || cat << EOF >> /etc/athena/rc.conf
SENDMAIL=false;		export SENDMAIL		#  Sendmail daemon?
EOF

%ifos linux
chkconfig --add athena-sendmail
%endif
cp /dev/null /etc/sendmail.st && chmod 644 /etc/sendmail.st

%ifos linux
%preun
if [ $1 = 0 ]; then
  chkconfig --del athena-sendmail
fi
%endif
