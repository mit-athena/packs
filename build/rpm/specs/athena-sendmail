Name: athena-sendmail
Summary: The Sendmail Mail Transport Agent, for Athena
Copyright: BSD
Group: System Environment/Daemons

Requires: athena-hesiod
Provides: smtpdaemon

%description
The Mail Transfer Agent for Athena.

%install
if [ X$RPM_BUILD_ROOT = X ]; then
  cat 1>&2 << MESSAGE
You must specify a build root in order to build this package.
Use the --buildroot option to RPM or the buildroot rpmrc entry.
MESSAGE
  exit 1
fi

rm -rf $RPM_BUILD_ROOT
mkdir $RPM_BUILD_ROOT
./do.sh -p -s /xxx -d $RPM_BUILD_ROOT install

# Extra files
mkdir -p $RPM_BUILD_ROOT/etc/rc.d/init.d
cp aliases $RPM_BUILD_ROOT/etc/aliases
cp sendmail.cf $RPM_BUILD_ROOT/etc/sendmail.cf
cp athena-sendmail.rc $RPM_BUILD_ROOT/etc/rc.d/init.d/athena-sendmail
chmod +x $RPM_BUILD_ROOT/etc/rc.d/init.d/athena-sendmail
mkdir -p $RPM_BUILD_ROOT/var/spool/mqueue
ln -s ../sbin/sendmail $RPM_BUILD_ROOT/usr/lib/sendmail

find $RPM_BUILD_ROOT -type f -or -type l |
  sed -e "s|^$RPM_BUILD_ROOT||" \
      -e "s|^/etc/aliases$|%config \0|" \
      -e "s|^/etc/sendmail.cf$|%config \0|" \
      -e "\,^/etc/sendmail.st$,d" |
  sort > rpm.filelist
echo "%dir /var/spool/mqueue" >> rpm.filelist



%post
grep -q ^SENDMAIL /etc/athena/rc.conf || cat << EOF >> /etc/athena/rc.conf
SENDMAIL=false;		export SENDMAIL		#  Sendmail daemon?
EOF

chkconfig --add athena-sendmail
cp /dev/null /etc/sendmail.st && chmod 644 /etc/sendmail.st
/usr/sbin/sendmail -bi

%preun
if [ $1 = 0 ]; then
  chkconfig --del athena-sendmail
fi
