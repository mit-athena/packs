Name: athena-krb5
Summary: Version 5 of the Kerberos system
License: MIT
Group: System Environment/Base

%description
The Kerberos secure net authentication system.

%build
./do.sh -p -s /xxx -d $RPM_BUILD_ROOT prepare
./do.sh -p -s /xxx -d $RPM_BUILD_ROOT all

cp athena-version src/appl/athena-version
(cd src/appl; ../../do.sh -p -s /xxx -d $RPM_BUILD_ROOT all)

%install
rm -rf $RPM_BUILD_ROOT
mkdir $RPM_BUILD_ROOT
./do.sh -p -s /xxx -d $RPM_BUILD_ROOT install

cp athena-version src/appl/athena-version
(cd src/appl; ../../do.sh -p -s /xxx -d $RPM_BUILD_ROOT install)

# Extra files; see prep/athena-krb5.
cp krb.conf $RPM_BUILD_ROOT/etc/athena/krb.conf
cp krb.realms $RPM_BUILD_ROOT/etc/athena/krb.realms
cp krb5.conf $RPM_BUILD_ROOT/etc/krb5.conf.athena
cp ftpusers $RPM_BUILD_ROOT/etc
mkdir -p $RPM_BUILD_ROOT/var/athena/sessions

%ifos linux
mkdir -p $RPM_BUILD_ROOT/etc/athena/network-scripts/user
cp user-kerberos.sh $RPM_BUILD_ROOT/etc/athena/network-scripts/user/20kerberos
chmod +x $RPM_BUILD_ROOT/etc/athena/network-scripts/user/20kerberos
%endif

%ifos linux
# Don't install /bin/login on Linux.
rm $RPM_BUILD_ROOT/bin/login
%endif


find $RPM_BUILD_ROOT -type f -or -type l |
  sed -e "s|^$RPM_BUILD_ROOT||" \
      -e "s|^/etc/athena/krb.conf$|%config \0|" \
      -e "s|^/etc/athena/krb.realms$|%config \0|" \
      -e "s|^/etc/ftpusers$|%config \0|" |
  sort > rpm.filelist
echo "%dir /var/athena/sessions" >> rpm.filelist

%ifos linux
%triggerin -- initscripts
# Use the krb5 login on virtual consoles.  Also undo any previous
# use of the Athena mingetty (which was based on an older version
# of mingetty, without the --loginprog option).
sed -e 's|/etc/athena/mingetty|/sbin/mingetty|' \
    -e 's|/sbin/mingetty tty|/sbin/mingetty --loginprog=/usr/athena/etc/login.krb5 tty|' \
  /etc/inittab > /etc/inittab.new && mv /etc/inittab.new /etc/inittab

%triggerin -- krb5-libs
%else
%post
%endif
cp -f /etc/krb5.conf /etc/krb5.conf.aside
cp -f /etc/krb5.conf.athena /etc/krb5.conf

%ifos linux
%preun
[ $1 = 0 ] || exit 0
sed -e 's|/sbin/mingetty --loginprog=/usr/athena/etc/login.krb5 tty|/sbin/mingetty tty|' \
  /etc/inittab > /etc/inittab.new && mv /etc/inittab.new /etc/inittab
%endif
