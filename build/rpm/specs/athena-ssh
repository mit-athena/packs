Name: athena-ssh
Summary: The Secure remote Shell program
Copyright: SSH Communications Security, Ltd.
Group: Applications/Internet

Requires: athena-krb5 athena-inetd

%description
The ssh secure shell system, as configured for Athena. 

%install
if [ X$RPM_BUILD_ROOT = X ]; then
  cat 1>&2 << MESSAGE
You must specify a build root in order to build this package.
Use the --buildroot option to RPM or the buildroot rpmrc entry.
MESSAGE
  exit 1
fi

rm -rf $RPM_BUILD_ROOT
mkdir $RPM_BUILD_ROOT
./do.sh -p -s /xxx -d $RPM_BUILD_ROOT install

# Extra file
mkdir -p $RPM_BUILD_ROOT/etc/rc.d/init.d
cp sshd_config $RPM_BUILD_ROOT/etc/sshd_config
cp athena-sshd.rc $RPM_BUILD_ROOT/etc/rc.d/init.d/athena-sshd
chmod +x $RPM_BUILD_ROOT/etc/rc.d/init.d/athena-sshd

find $RPM_BUILD_ROOT -type f -or -type l |
  sed -e "s|^$RPM_BUILD_ROOT||" \
      -e "s|^/etc/sshd_config$|%config \0|" |
  sort > rpm.filelist

%post
grep -q ^SSHD /etc/athena/rc.conf || cat << EOF >> /etc/athena/rc.conf
SSHD=false;		export SSHD		#  Secure shell daemon
EOF

if [ ! -f /etc/ssh_host_key ]; then
	echo "Generating ssh host key."
	/usr/athena/bin/ssh-keygen -b 1024 -f /etc/ssh_host_key -N ''
fi
chkconfig --add athena-sshd

