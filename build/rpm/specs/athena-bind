Name: athena-bind
Summary: The Berkeley Internet Name Daemon, implementing DNS for Athena
Copyright: BSD
Group: System Environment/Daemons

%description 
The BIND server and nameservice libraries, as configured for Athena
workstations.

%install

if [ X$RPM_BUILD_ROOT = X ]; then
  cat 1>&2 << MESSAGE
You must specify a build root in order to build this package.
Use the --buildroot option to RPM or the buildroot rpmrc entry.
MESSAGE
  exit 1
fi

rm -rf $RPM_BUILD_ROOT
mkdir $RPM_BUILD_ROOT
./do.sh -p -s /xxx -d $RPM_BUILD_ROOT install

# Extra files
mkdir -p $RPM_BUILD_ROOT/etc/rc.d/init.d
cp named.conf 			$RPM_BUILD_ROOT/etc/named.conf
cp named.localhost		$RPM_BUILD_ROOT/etc/named.localhost
cp named.localhost.rev		$RPM_BUILD_ROOT/etc/named.localhost.rev
cp named.root			$RPM_BUILD_ROOT/etc/named.root
cp resolv.conf			$RPM_BUILD_ROOT/etc/resolv.conf
cp athena-bind.rc		$RPM_BUILD_ROOT/etc/rc.d/init.d/athena-bind
chmod +x $RPM_BUILD_ROOT/etc/rc.d/init.d/athena-bind

find $RPM_BUILD_ROOT -type f -or -type l |
  sed -e "s|^$RPM_BUILD_ROOT||" \
      -e "s|^/etc/named.conf$|%config \0|" \
      -e "s|^/etc/named.localhost$|%config \0|" \
      -e "s|^/etc/named.localhost.rev$|%config \0|" \
      -e "s|^/etc/named.root$|%config \0|" \
      -e "s|^/etc/resolv.conf$|%config \0|" |
  sort > rpm.filelist

%post
chkconfig --add athena-bind

# For a while the SIPB installer was creating resolv.conf withthe
# nameserver specified by the user (generally one of MITnet's
# nameservers) rather than localhost.
egrep -q "^nameserver.*(18.70.0.160|18.71.0.151|18.72.0.3)" /etc/resolv.conf
if [ $? = "0" ]; then
  rm -f /etc/resolv.conf.new /etc/resolv.conf.old
  sed -e "/^nameserver.*18.70.0.160/d" \
      -e "/^nameserver.*18.71.0.151/d" \
      -e "/^nameserver.*18.72.0.3/d" \
      -e "/^nameserver.*127.0.0.1/d" \
      /etc/resolv.conf > /etc/resolv.conf.new
  echo "nameserver 127.0.0.1" >> /etc/resolv.conf.new
  ln /etc/resolv.conf /etc/resolv.conf.old
  test -s /etc/resolv.conf.new && mv /etc/resolv.conf.new /etc/resolv.conf
fi

%preun
if [ $1 = 0 ]; then
  chkconfig --del athena-bind
fi
