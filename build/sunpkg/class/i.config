#!/bin/sh

# Process the config files in a package.
# For a PUBLIC=true machine, we will always copy in the package version
# of the file.  For non-PUBLIC machines, we have to determine whether
# the administrator has modified the target file from the previously
# installed package version, and if this version of the package has
# changed the file.

# Note whether this is a PUBLIC=true machine.
if [ -s $PKG_INSTALL_ROOT/etc/athena/rc.conf ]; then
  eval `grep '^PUBLIC=' $PKG_INSTALL_ROOT/etc/athena/rc.conf`
fi

# pkgadd supplies file source/destination pairs on our standard input.
while read src dest ; do
  noreplace=false
  if [ "$PUBLIC" != true -a -f $dest ]; then
    # We are updating the package on a non-PUBLIC machine.  See if the
    # target file has been modified by the administrator.
    cmp -s $dest $dest.athena || {
      # The administrator has modified the previously installed file.
      # See if the package version of the file has changed.
      if cmp -s $src $dest.athena ; then
	# The file is unchanged in the package; leave the modified version
	# in place.
	noreplace=true
      else
	# We have changed it in the package.  Save the edited version,
	# as we will replace it below.
	rm -f $dest.old
	cp -p $dest $dest.old || exit 1
	echo "Replacing $dest; the existing version has been"
	echo "saved as $dest.old"
      fi
    }
  fi
  # Copy in the new version, with the .athena suffix.
  rm -f $dest.athena
  cp -p $src $dest.athena || exit 1
  if [ $noreplace = false ]; then
    rm -f $dest
    cp -p $dest.athena $dest || exit 1
  fi
done      

exit 0
